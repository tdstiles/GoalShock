## 2026-01-18 - AsyncIO Task Mocking **Learning:**.
Mocking infinite loops in `asyncio` applications requires careful handling of task cancellation. When `asyncio.gather` is used to run background tasks, simply mocking them to return immediately causes `gather` to finish, which might prematurely shut down the application if not handled. If mocking them to run forever, they must check the application's running state or handle cancellation gracefuly; otherwise `asyncio.gather` waits forever, preventing clean shutdown during tests.
**Action:** When testing `asyncio` main loops, use a side-effect that checks the `running` flag (e.g., `while engine.running: await asyncio.sleep(0.01)`) to ensure the loop behaves realistically but exits when stopped. Also, ensure `engine.stop()` is awaited and verify `engine.running` transitions to False.
## 2026-01-18 - Pytest Import Paths **Learning:**.
When testing in a structure where `conftest.py` adds the source directory (e.g., `backend/`) to `sys.path`, tests must import modules relative to that source directory (e.g., `from bot...`) rather than including the parent directory (e.g., `from backend.bot...`). Using the parent directory prefix will cause `ModuleNotFoundError` because the parent directory itself is not a package in the path.
